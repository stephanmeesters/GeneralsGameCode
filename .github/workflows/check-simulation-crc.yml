name: Check Simulation CRC

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      game:
        required: true
        type: string
        description: "Game to check (only GeneralsMD for now)"
      preset:
        required: true
        type: string
        description: "Artifact preset suffix (e.g. vc6+t+e, win32+t+e)"

jobs:
  check:
    name: ${{ inputs.preset }}
    runs-on: windows-2022
    timeout-minutes: 10
    env:
      GAME_PATH: C:\GameData
      GENERALS_PATH: C:\GameData\Generals
      GENERALSMD_PATH: C:\GameData\GeneralsMD
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Download Game Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.game }}-${{ inputs.preset }}
          path: build

      - name: Cache Game Data
        id: cache-gamedata
        uses: actions/cache@v4
        with:
          path: ${{ env.GAME_PATH }}
          key: gamedata-permanent-cache-v4

      - name: Download Game Data from Cloudflare R2
        if: ${{ steps.cache-gamedata.outputs.cache-hit != 'true' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
          EXPECTED_HASH_GENERALS: "37A351AA430199D1F05DEB9E404857DCE7B461A6AC272C5D4A0B5652CDB06372"
          EXPECTED_HASH_GENERALSMD: "6837FE1E3009A4C239406C39B1598216C0943EE8ED46BB10626767029AC05E21"
        shell: pwsh
        run: |
          if (-not $env:AWS_ACCESS_KEY_ID -or -not $env:AWS_SECRET_ACCESS_KEY -or -not $env:AWS_ENDPOINT_URL) {
              $ok1 = [bool]$env:AWS_ACCESS_KEY_ID
              $ok2 = [bool]$env:AWS_SECRET_ACCESS_KEY
              $ok3 = [bool]$env:AWS_ENDPOINT_URL
              Write-Host "One or more required secrets are not set or are empty. R2_ACCESS_KEY_ID: $ok1, R2_SECRET_ACCESS_KEY: $ok2, R2_ENDPOINT_URL: $ok3"
              exit 1
          }

          Write-Host "Downloading Game Data for Generals" -ForegroundColor Cyan
          aws s3 cp s3://github-ci/generals108_gamedata_trimmed.7z generals108_gamedata_trimmed.7z --endpoint-url $env:AWS_ENDPOINT_URL

          Write-Host "Verifying File Integrity" -ForegroundColor Cyan
          $fileHash = (Get-FileHash -Path generals108_gamedata_trimmed.7z -Algorithm SHA256).Hash
          if ($fileHash -ne $env:EXPECTED_HASH_GENERALS) {
              Write-Error "Hash verification failed for Generals gamedata!"
              exit 1
          }

          Write-Host "Extracting Archive" -ForegroundColor Cyan
          & 7z x generals108_gamedata_trimmed.7z -o"$env:GENERALS_PATH"
          Remove-Item generals108_gamedata_trimmed.7z -Verbose

          Write-Host "Downloading Game Data for GeneralsMD" -ForegroundColor Cyan
          aws s3 cp s3://github-ci/zerohour104_gamedata_trimmed.7z zerohour104_gamedata_trimmed.7z --endpoint-url $env:AWS_ENDPOINT_URL

          Write-Host "Verifying File Integrity" -ForegroundColor Cyan
          $fileHash = (Get-FileHash -Path zerohour104_gamedata_trimmed.7z -Algorithm SHA256).Hash
          if ($fileHash -ne $env:EXPECTED_HASH_GENERALSMD) {
              Write-Error "Hash verification failed for GeneralsMD gamedata!"
              exit 1
          }

          Write-Host "Extracting Archive" -ForegroundColor Cyan
          & 7z x zerohour104_gamedata_trimmed.7z -o"$env:GENERALSMD_PATH"
          Remove-Item zerohour104_gamedata_trimmed.7z -Verbose

      - name: Set Up Game Data
        shell: pwsh
        run: |
          $source = "$env:GAME_PATH\${{ inputs.game }}"
          $destination = "build"
          Copy-Item -Path $source\* -Destination $destination -Recurse -Force

      - name: Set Generals InstallPath in Registry
        shell: pwsh
        run: |
          $regPath = "HKCU:\SOFTWARE\Electronic Arts\EA Games\Generals"
          $installPath = "$env:GENERALS_PATH\"

          if (-not (Test-Path $regPath)) {
            New-Item -Path $regPath -Force | Out-Null
          }

          Set-ItemProperty -Path $regPath -Name InstallPath -Value $installPath -Type String
          Write-Host "Registry key set: $regPath -> InstallPath = $installPath"

      - name: Run Simulation CRC
        shell: pwsh
        run: |
          $exePath = "build/generalszh.exe"
          $arguments = "-printSimMathCrc"
          $timeoutSeconds = 60
          $stdoutPath = "stdout.log"
          $stderrPath = "stderr.log"

          if (-not (Test-Path $exePath)) {
              Write-Host "ERROR: Executable not found at $exePath"
              exit 1
          }

          Remove-Item $stdoutPath, $stderrPath -ErrorAction SilentlyContinue

          Write-Host "Run $exePath $arguments"
          $process = Start-Process -FilePath $exePath `
              -ArgumentList $arguments `
              -RedirectStandardOutput $stdoutPath `
              -RedirectStandardError $stderrPath `
              -PassThru

          $exited = $process.WaitForExit($timeoutSeconds * 1000)
          if (-not $exited) {
              Write-Host "ERROR: Process still running after $timeoutSeconds seconds. Killing process..."
              Stop-Process -Id $process.Id -Force
              exit 1
          }

          Write-Host "=== STDOUT ==="
          if (Test-Path $stdoutPath) { Get-Content $stdoutPath }

          if ((Test-Path $stderrPath) -and (Get-Item $stderrPath).Length -gt 0) {
              Write-Host "`n=== STDERR ==="
              Get-Content $stderrPath
          }

          $exitCode = $process.ExitCode
          if ($exitCode -ne 0) {
              Write-Host "ERROR: Process failed with exit code $exitCode"
              exit $exitCode
          }

          if (-not (Test-Path $stdoutPath)) {
              Write-Host "ERROR: Missing stdout log"
              exit 1
          }

          $match = Select-String -Path $stdoutPath -Pattern "Simulation CRC: [0-9A-Fa-f]{8}" -SimpleMatch
          if (-not $match) {
              Write-Host "ERROR: Did not find 'Simulation CRC: ' line in stdout"
              exit 1
          }

          Write-Host "Success!"

      - name: Upload Simulation CRC Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SimulationCRC-Logs-${{ inputs.preset }}
          path: |
            stdout.log
            stderr.log
            build/DebugLogFile*.txt
          retention-days: 30
          if-no-files-found: ignore

